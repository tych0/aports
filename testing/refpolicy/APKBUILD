# Maintainer: Tycho Andersen <tycho@docker.com>
pkgname=refpolicy
pkgver=20130424
pkgrel=0
pkgdesc="SELinux policy reference"
url="https://github.com/TresysTechnology/refpolicy/wiki"
arch="noarch"
license="GPLv2"
depends=""
depends_dev=""
makedepends="$depends_dev checkpolicy python gawk"
install=""
subpackages="$pkgname-doc"
source="https://raw.githubusercontent.com/wiki/TresysTechnology/refpolicy/files/refpolicy-2.$pkgver.tar.bz2
	policy-rhel-7.1-base.patch
	"
builddir="$srcdir/refpolicy"

# policyref config
monolithic=n
distro=redhat
unknown_perms=deny

# This is mostly transliterated from the CentOS spec file
makeCmds() {
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=1024 bare || return 1
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=1024 conf || return 1
	#cp $startdir/booleans-$1.conf policy/booleans.conf || return 1
	#cp $startdir/users-$1 policy/users || return 1
}

installCmds() {
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=0124 SEMOD_EXP="/usr/bin/semodule_expand -a" base.pp
	make validate UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=1024 SEMOD_EXP="/usr/bin/semodule_expand -a" modules
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=0124 DESTDIR="$pkgdir" install
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=0124 DESTDIR="$pkgdir" install-appconfig
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=0124 DESTDIR="$pkgdir" install-docs
	make UNK_PERMS=$3 NAME=$1 TYPE=$2 DISTRO=$distro UBAC=n DIRECT_INITRC=y MONOLITHIC=$monolithic MLS_CATS=1024 MCS_CATS=0124 DESTDIR="$pkgdir" install-headers
}

build() {
	cd "$builddir"
	makeCmds targeted mcs $unknown_perms || return 1
}

package() {
	cd "$builddir"
	echo packaging now
	installCmds targeted mcs $unknown_perms || return 1
	mkdir -p $pkgdir/usr/share/selinux/devel || return 1
	mv "$pkgdir/usr/share/selinux/targeted/include" "$pkgdir/usr/share/selinux/devel/include"
	cp $startdir/Makefile.devel "$pkgdir/usr/share/selinux/devel/Makefile" || return 1
	install -m 644 doc/example.* "$pkgdir/usr/share/selinux/devel" || return 1
	install -m 644 doc/policy.* "$pkgdir/usr/share/selinux/devel" || return 1
	# TODO: libselinux needs to build the python bindings for this to work
	# sepolicy manpage -a -p "$pkgdir/usr/share/man/man8/" -w -r "$pkgdir" || return 1
	}

sha512sums="82ab38bc3425eb4b7d50c42564ebc28603e32e6f3266da164502f0cdc3a2f6bfe457518297824cb78f6f94211f9823fbc7254bb9e1d9df1cc7f284d326299705  refpolicy-2.20130424.tar.bz2
f815a6cec7d8fc2d45c30d72b5feecf820ece5a748b5c17091ae473b73d010ec473b6fecad78628a893ccd184bf1012a090a30bc58b64ec2fe8d568c7113cde6  policy-rhel-7.1-base.patch"
